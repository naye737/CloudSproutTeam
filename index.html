<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlie Puth World Tour - í‹°ì¼“ ì˜ˆë§¤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: url('concert-bg.jpg') center/cover no-repeat fixed; color: white; }
        .container { max-width: 900px; margin: auto; background: rgba(51, 51, 51, 0.9); padding: 20px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); text-align: center; }
        .header img { max-width: 100%; }
        .details { padding: 20px; }
        .section { background: rgba(255, 255, 255, 0.1); padding: 20px; margin-top: 20px; border-radius: 10px; }
        .input-field { width: 80%; padding: 10px; margin: 5px; font-size: 16px; }
        .btn { display: block; width: 100%; padding: 15px; border: none; font-size: 18px; cursor: pointer; text-align: center; margin-top: 10px; }
        .btn-primary { background: #ff4c4c; color: white; } .btn-primary:hover { background: #d43f3f; }
        .btn-secondary { background: #4CAF50; color: white; } .btn-secondary:hover { background: #45a049; }
        .ticket-result { margin-top: 20px; font-size: 18px; font-weight: bold; background: white; color: black; padding: 15px; display: none; }
        .seating-area { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; padding: 20px; justify-content: center; align-items: center; }
        .seat { width: 40px; height: 40px; text-align: center; line-height: 40px; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .vip { background: gold; color: black; } .r { background: red; color: white; } .s { background: blue; color: white; } .a { background: green; color: white; }
        .selected { background: black !important; color: white; }
        .booked { background: darkgray !important; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="charlie-puth-tour.jpg" alt="Charlie Puth World Tour">
    </div>

    <div class="details">
        <h1>Charlie Puth World Tour 2025</h1>
        <p><strong>ğŸ“… ê³µì—° ë‚ ì§œ:</strong> 2025ë…„ 5ì›” 10ì¼ PM 7:00 </p>
        <p><strong>ğŸ“ ê³µì—° ì¥ì†Œ:</strong> ê³ ì²™ SKY ë”</p>
        <p><strong>ğŸ« í‹°ì¼“ ê°€ê²©:</strong> VIP 250,000ì› | Rì„ 180,000ì› | Sì„ 120,000ì› | Aì„ 80,000ì›</p>
    </div>

    <!-- âœ… ì¢Œì„ ì„ íƒ -->
    <div class="section">
        <h2>ì¢Œì„ ì„ íƒ</h2>
        <div class="seating-area" id="seatContainer"></div>

        <h2>ì˜ˆë§¤í•˜ê¸°</h2>
        <input type="text" id="reserveName" class="input-field" placeholder="ì´ë¦„ ì…ë ¥ (ìµœëŒ€ 10ì)" maxlength="10" data-type="name">
        <input type="text" id="reservePhone" class="input-field" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 01012345678)" maxlength="11" data-type="phone">
        <button class="btn btn-primary" onclick="reserveSeats()">ì˜ˆë§¤í•˜ê¸°</button>
    </div>
    <!-- âœ… ì˜ˆë§¤ ë‚´ì—­ í™•ì¸ ì„¹ì…˜ -->
    <div class="section">
        <h2>ì˜ˆë§¤ ë‚´ì—­ í™•ì¸</h2>
        <input type="text" id="checkName" class="input-field" placeholder="ì´ë¦„ ì…ë ¥ (ìµœëŒ€ 10ì)" maxlength="10" data-type="name">
        <input type="text" id="checkPhone" class="input-field" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥" maxlength="11" data-type="phone">
        <button class="btn btn-secondary" onclick="fetchMyTickets()">ì˜ˆë§¤ ë‚´ì—­ í™•ì¸</button>
        <div class="ticket-result" id="ticketResult"></div>
    </div>

</div>

<script>
    const API_URL = "https://api.cloudee.today/api";
    const seatContainer = document.getElementById("seatContainer");
    let selectedSeats = [];
    const MAX_SEATS_PER_PERSON = 10; // âœ… ìµœëŒ€ ì„ íƒ ê°€ëŠ¥ ì¢Œì„ 10ê°œ

    let isComposing = false;  // í•œê¸€ ì¡°í•© ìƒíƒœ ì—¬ë¶€

    // âœ… ì…ë ¥ í•„í„°ë§ í•¨ìˆ˜ (í•œê¸€ ì…ë ¥ ë¬¸ì œ í•´ê²°)
    function validateInput(inputId, type) {
        let inputField = document.getElementById(inputId);

        // í•œê¸€ ì…ë ¥ ì¡°í•© ì¤‘ì´ë©´ í•„í„°ë§ ì ìš© ì•ˆ í•¨
        if (isComposing) return;

        let newValue = type === "name"
            ? inputField.value.replace(/[^ê°€-í£a-zA-Z]/g, '')  // í•œê¸€ & ì˜ì–´ë§Œ í—ˆìš©
            : inputField.value.replace(/[^0-9]/g, '');  // ìˆ«ìë§Œ í—ˆìš©

        if (inputField.value !== newValue) {
            inputField.value = newValue;
        }
    }

    // âœ… í•œê¸€ ì¡°í•© ì‹œì‘ ì‹œ í•„í„°ë§ ì¤‘ì§€
    function startComposition() {
        isComposing = true;
    }

    // âœ… í•œê¸€ ì¡°í•© ì™„ë£Œ í›„ í•„í„°ë§ ì ìš©
    function endComposition(event) {
        isComposing = false;
        validateInput(event.target.id, event.target.getAttribute("data-type"));
    }

    // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener("DOMContentLoaded", () => {
        let nameFields = document.querySelectorAll("input[data-type='name']");
        let phoneFields = document.querySelectorAll("input[data-type='phone']");

        nameFields.forEach(field => {
            field.addEventListener("compositionstart", startComposition);
            field.addEventListener("compositionend", endComposition);
            field.addEventListener("input", (e) => validateInput(e.target.id, "name"));
        });

        phoneFields.forEach(field => {
            field.addEventListener("input", (e) => validateInput(e.target.id, "phone"));
        });
    });


    function validateReservePhone() {
        let phoneField = document.getElementById("reservePhone");
        phoneField.value = phoneField.value.replace(/[^0-9]/g, ''); // ë¬¸ì ì œê±°
    }

    // âœ… ì˜ˆë§¤ ì¡°íšŒ ì…ë ¥ í•„í„°ë§
    function validateReserveName() {
    let nameField = document.getElementById("reserveName");
    let cursorPosition = nameField.selectionStart; // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥

    let newValue = nameField.value.replace(/[^ê°€-í£a-zA-Z]/g, ''); // ìˆ«ì ë° íŠ¹ìˆ˜ ë¬¸ì ì œê±°
    if (nameField.value !== newValue) {
        nameField.value = newValue;
        nameField.setSelectionRange(cursorPosition, cursorPosition); // ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
    }
}


    function validateCheckPhone() {
        let phoneField = document.getElementById("checkPhone");
        phoneField.value = phoneField.value.replace(/[^0-9]/g, ''); // ë¬¸ì ì œê±°
    }

    // âœ… ì¢Œì„ ì˜ˆë§¤ í•¨ìˆ˜
    async function reserveSeats() {
        const name = document.getElementById("reserveName").value.trim();
        const phone = document.getElementById("reservePhone").value.trim();

        if (!name || !phone) {
            alert("ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        try {
            const response = await fetch(`${API_URL}/tickets/reserve`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, phone })
            });

            const data = await response.json();

            if (response.ok) {
                alert("âœ… ì˜ˆë§¤ ì„±ê³µ! ì¢Œì„ì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.reload();
            } else {
                alert("âŒ ì˜ˆë§¤ ì‹¤íŒ¨: " + data.message);
            }
        } catch (error) {
            alert("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error("ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨:", error);
        }
    }

// âœ… ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ í•¨ìˆ˜
async function fetchMyTickets() {
        const name = document.getElementById("checkName").value.trim();
        const phone = document.getElementById("checkPhone").value.trim();

        if (!name || !phone) {
            alert("ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        try {
            const response = await fetch(`${API_URL}/tickets/check?name=${encodeURIComponent(name)}&phone=${phone}`);
            const data = await response.json();

            if (response.ok) {
                if (data.seats && data.seats.length > 0) {
                    let message = `âœ… ì˜ˆë§¤ ë‚´ì—­ í™•ì¸<br>
                    <strong>ì´ë¦„:</strong> ${name}<br>
                    <strong>ì „í™”ë²ˆí˜¸:</strong> ${phone}<br>
                    <strong>ì˜ˆë§¤í•œ ì¢Œì„:</strong> ${data.seats.join(", ")}<br>
                    2025ë…„ 5ì›” 10ì¼ ì €ë… 7ì‹œ ê³ ì²™ìŠ¤ì¹´ì´ë”ì—ì„œ ë§Œë‚˜ìš”!`;

                    document.getElementById("ticketResult").innerHTML = message;
                    document.getElementById("ticketResult").style.display = "block";
                } else {
                    alert("âŒ ì˜ˆë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
                    document.getElementById("ticketResult").style.display = "none";
                }
            } else {
                alert("âŒ ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: " + data.message);
                document.getElementById("ticketResult").style.display = "none";
            }
        } catch (error) {
            alert("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error("ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨:", error);
            document.getElementById("ticketResult").style.display = "none";
        }
    }

    function validateReserveName() {
        document.getElementById("checkName").value = document.getElementById("reserveName").value.replace(/[^ê°€-í£a-zA-Z]/g, '');
    }

    function validateReservePhone() {
        document.getElementById("checkPhone").value = document.getElementById("reservePhone").value.replace(/[^0-9]/g, '');
    }

    async function fetchSeats() {
        try {
            const response = await fetch(`${API_URL}/tickets/booked`);
            const data = await response.json();

            if (response.ok) {
                data.forEach(seatNumber => {
                    let seatElement = document.querySelector(`.seat[data-number="${seatNumber}"]`);
                    if (seatElement) {
                        seatElement.classList.add("booked");
                    }
                });
            }
        } catch (error) {
            console.error("ğŸš¨ ì˜ˆë§¤ëœ ì¢Œì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    function createSeat(type, index) {
        const seat = document.createElement("div");
        seat.classList.add("seat", type);
        seat.textContent = index;
        seat.setAttribute("data-number", index);

        seat.addEventListener("click", function () {
            if (this.classList.contains("booked")) return;

            if (this.classList.contains("selected")) {
                this.classList.remove("selected");
            } else {
                if (selectedSeats.length >= MAX_SEATS_PER_PERSON) {
                    alert(`âŒ í•œ ì‚¬ëŒë‹¹ ìµœëŒ€ ${MAX_SEATS_PER_PERSON}ê°œ ì¢Œì„ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`);
                    return;
                }
                this.classList.add("selected");
            }

            updateSelectedSeats();
        });

        seatContainer.appendChild(seat);
    }

    function updateSelectedSeats() {
        selectedSeats = Array.from(document.querySelectorAll(".seat.selected")).map(seat => seat.getAttribute("data-number"));
    }

    function generateSeating() {
        const sections = [
            { type: "vip", count: 50 },
            { type: "r", count: 50 },
            { type: "s", count: 50 },
            { type: "a", count: 50 }
        ];

        let seatIndex = 1;
        sections.forEach((section) => {
            for (let i = 1; i <= section.count; i++) {
                createSeat(section.type, seatIndex++);
            }
        });

        fetchSeats(); // ì˜ˆë§¤ëœ ì¢Œì„ ê°€ì ¸ì˜¤ê¸°
    }

    async function reserveSeats() {
        const name = document.getElementById("reserveName").value.trim();
        const phone = document.getElementById("reservePhone").value.trim();

        if (!name || !phone || selectedSeats.length === 0) {
            alert("ì´ë¦„, ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ì¢Œì„ì„ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        if (selectedSeats.length > MAX_SEATS_PER_PERSON) {
            alert(`âŒ í•œ ì‚¬ëŒë‹¹ ìµœëŒ€ ${MAX_SEATS_PER_PERSON}ê°œ ì¢Œì„ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            return;
        }

        try {
            const response = await fetch(`${API_URL}/tickets/reserve`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, phone, seats: selectedSeats })
            });

            const data = await response.json();

            if (response.ok) {
                alert(`âœ… ì˜ˆë§¤ ì„±ê³µ! ì„ íƒí•œ ì¢Œì„: ${selectedSeats.join(", ")}`);
                window.location.reload();
            } else {
                alert("âŒ ì˜ˆë§¤ ì‹¤íŒ¨: " + data.message);
            }
        } catch (error) {
            alert("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error("ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨:", error);
        }
    }

    generateSeating();
    
</script>

</body>
</html>
